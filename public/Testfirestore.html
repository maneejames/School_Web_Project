<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Document</title>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
            import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, browserLocalPersistence, setPersistence} from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
            import { getFirestore, collection, addDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

            const firebaseConfig = {
                    apiKey: "AIzaSyAIwzxvlLd9UTZXC_qc3fqZ9Qarifhjzcs",
                    authDomain: "school-openhouse.firebaseapp.com",
                    projectId: "school-openhouse",
                    storageBucket: "school-openhouse.appspot.com",
                    messagingSenderId: "321971868041",
                    appId: "1:321971868041:web:66ddb25a464ab8ea11d158"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const firestore = getFirestore(app);

            const signupForm = document.getElementById('signup-form');
            const loginForm = document.getElementById('login-form');

            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const classroom = document.getElementById('classroom').value; // Add classroom input field
                const stamps = [
                    { name: 'Stamp 1', value: false },
                    { name: 'Stamp 2', value: false },
                    { name: 'Stamp 3', value: false }
                ];

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // Store user data in Firestore
                    const usersCollection = collection(firestore, 'users');
                    await addDoc(usersCollection, {
                        email: user.email,
                        classroom: classroom, // Store classroom data
                        stamps: stamps,
                    });

                    alert('User registration successful');

                    // Redirect to another page after successful sign-up
                    window.location.href = 'login-already.html';
                } catch (error) {
                    alert('User registration failed. ' + error.message);
                }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    alert('User login successful');

                    // Redirect to another page after successful login
                    window.location.href = 'login-already.html';
                } catch (error) {
                    alert('User login failed. ' + error.message);
                }
            });

            const code1 = "123"; // Replace with your code
            const code2 = "456"; // Replace with your code
            const code3 = "789"; // Replace with your code

            const stampButton = document.getElementById('stamp-button');
            stampButton.addEventListener('click', async () => {
                console.log(firebase.auth().currentUser)
                const codeInput = prompt('Enter a code:');
                if (codeInput === code1 || codeInput === code2 || codeInput === code3) {
                    // Valid code, set the stamp to true for the current user
                    const user = auth.currentUser;
                    if (user) {
                        // Update the Firestore document to set the stamp to true
                        const userDoc = doc(firestore, 'users', user.uid);
                        await updateDoc(userDoc, {
                            stamps: {
                                [codeInput]: true
                            }
                        });
                        alert('Stamp set to true!');
                    } else {
                        alert('User not logged in.');
                    }
                } else {
                    alert('Invalid code.');
                }
            });

            // setPersistence(auth, inMemoryPersistence)
            // .then(() => {
            //     // Initialize the app or continue with your application logic

            //     // Check user authentication state on page load
            //     onAuthStateChanged(auth, (user) => {
            //         if (user) {
            //             // User is signed in
            //             console.log('User is signed in:', user.email);
            //         } else {
            //             // User is signed out
            //             console.log('User is signed out');
            //         }
            //     });
            // })
            // .catch((error) => {
            //     console.error('Error enabling persistence:', error);
            // });

            // setPersistence(auth, browserLocalPersistence)
            // .then(() => {
            //     // Existing and future Auth states are now persisted in the current
            //     // session only. Closing the window would clear any existing state even
            //     // if a user forgets to sign out.
            //     // ...
            //     // New sign-in will be persisted with session persistence.
            //     return signInWithEmailAndPassword(auth, email, password);
            // })
            // .catch((error) => {
            //     // Handle Errors here.
            //     const errorCode = error.code;
            //     const errorMessage = error.message;
            // });

        </script>
    </head>

    <body>
        <!-- Your HTML content here -->

        <h2>Sign Up</h2>
        <form id="signup-form">
            <input type="email" id="signup-email" placeholder="Email" required>
            <input type="password" id="signup-password" placeholder="Password" required>
            <input type="text" id="classroom" placeholder="Classroom" required> <!-- Add classroom input field -->
            <button type="submit">Sign Up</button>
        </form>

        <h2>Login</h2>
        <form id="login-form">
            <input type="email" id="login-email" placeholder="Email" required>
            <input type="password" id="login-password" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>

        <button id="stamp-button">Set Stamp to True</button>
    </body>
</html>

